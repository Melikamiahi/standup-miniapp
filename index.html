<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <title>ØªØµØ§Ø¯ÙÛŒâ€ŒØ³Ø§Ø² Ø§Ø³ØªÙ†Ø¯Ø¢Ù¾ â€” ØªÛŒÙ… Ú©Ø§Ø±ÙˆØ§Ù†</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://tapi.bale.ai/miniapp.js?3"></script>
  <style>
    :root {
      --bg: #1a1a2e;
      --surface: #16213e;
      --surface-hover: #1f3460;
      --accent: #e94560;
      --accent-soft: rgba(233, 69, 96, 0.2);
      --text: #eaeaea;
      --text-muted: #a0a0a0;
      --success: #4ecca3;
      --border: #2a2a4a;
      --font: 'Vazirmatn', 'Tahoma', sans-serif;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: var(--font);
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      min-height: 100dvh;
      overflow-x: hidden;
      -webkit-font-smoothing: antialiased;
    }

    .container {
      max-width: 480px;
      margin: 0 auto;
      padding: 1rem;
      padding-bottom: env(safe-area-inset-bottom, 1rem);
    }

    h1 {
      font-size: 1.35rem;
      font-weight: 700;
      text-align: center;
      margin-bottom: 1.25rem;
      color: var(--text);
    }

    .screen {
      display: none;
      animation: fadeIn 0.3s ease;
    }
    .screen.active {
      display: block;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(8px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* Setup: members */
    .member-form {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 1rem;
    }
    .member-form input {
      flex: 1;
      padding: 0.75rem 1rem;
      border: 1px solid var(--border);
      border-radius: 12px;
      background: var(--surface);
      color: var(--text);
      font-family: var(--font);
      font-size: 1rem;
    }
    .member-form input::placeholder {
      color: var(--text-muted);
    }
    .member-form input:focus {
      outline: none;
      border-color: var(--accent);
    }

    .btn {
      padding: 0.75rem 1.25rem;
      border: none;
      border-radius: 12px;
      font-family: var(--font);
      font-size: 0.95rem;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s, transform 0.1s;
    }
    .btn:active {
      transform: scale(0.98);
    }
    .btn-primary {
      background: var(--accent);
      color: #fff;
    }
    .btn-primary:hover {
      background: #d63a54;
    }
    .btn-secondary {
      background: var(--surface-hover);
      color: var(--text);
    }
    .btn-secondary:hover {
      background: #2a4070;
    }
    .btn-ghost {
      background: transparent;
      color: var(--accent);
    }
    .btn-small {
      padding: 0.4rem 0.75rem;
      font-size: 0.85rem;
    }
    .btn-icon {
      min-width: 44px;
      padding: 0.75rem;
    }

    .member-list {
      list-style: none;
    }
    .member-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0.85rem 1rem;
      background: var(--surface);
      border-radius: 12px;
      margin-bottom: 0.5rem;
      border: 1px solid var(--border);
    }
    .member-item .name {
      font-weight: 500;
    }
    .member-item .actions {
      display: flex;
      gap: 0.35rem;
    }
    .member-item .actions button {
      background: transparent;
      border: none;
      color: var(--text-muted);
      cursor: pointer;
      padding: 0.35rem;
      font-size: 1rem;
    }
    .member-item .actions button:hover {
      color: var(--accent);
    }

    .empty-state {
      text-align: center;
      padding: 2rem 1rem;
      color: var(--text-muted);
      font-size: 0.95rem;
    }

    /* Timer config */
    .timer-config {
      margin: 1.25rem 0;
      padding: 1rem;
      background: var(--surface);
      border-radius: 12px;
      border: 1px solid var(--border);
    }
    .timer-config label {
      display: block;
      font-size: 0.9rem;
      color: var(--text-muted);
      margin-bottom: 0.5rem;
    }
    .timer-config input[type="range"] {
      width: 100%;
      height: 8px;
      -webkit-appearance: none;
      appearance: none;
      background: var(--border);
      border-radius: 4px;
      margin: 0.5rem 0;
    }
    .timer-config input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 22px;
      height: 22px;
      background: var(--accent);
      border-radius: 50%;
      cursor: pointer;
    }
    .timer-config .value {
      font-weight: 600;
      color: var(--accent);
      transition: opacity 0.4s ease, transform 0.3s ease;
    }
    .timer-config .value.updated {
      animation: timerValueSoft 0.5s ease-out;
    }
    @keyframes timerValueSoft {
      0% { transform: scale(1); opacity: 1; }
      40% { transform: scale(1.06); opacity: 0.85; }
      100% { transform: scale(1); opacity: 1; }
    }

    /* Shuffle & Start */
    .shuffle-zone {
      margin: 1.5rem 0;
      min-height: 120px;
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      justify-content: center;
      align-items: center;
    }
    .team-name {
      display: block;
      font-size: 0.9rem;
      font-weight: 500;
      color: var(--text-muted);
      margin-top: 0.2rem;
    }
    .shuffle-chip {
      padding: 0.5rem 1rem;
      background: var(--surface-hover);
      border-radius: 999px;
      font-size: 0.9rem;
      transition: transform 0.6s ease-in-out, opacity 0.5s ease-in-out;
    }
    .shuffle-chip.shuffling {
      animation: shuffleGentle 1.2s ease-in-out;
    }
    @keyframes shuffleGentle {
      0% { transform: scale(1); opacity: 1; }
      30% { transform: scale(1.04); opacity: 0.92; }
      70% { transform: scale(1.04); opacity: 0.92; }
      100% { transform: scale(1); opacity: 1; }
    }

    .actions-row {
      display: flex;
      gap: 0.75rem;
      justify-content: center;
      flex-wrap: wrap;
      margin-top: 1.5rem;
    }
    .actions-row .btn {
      min-width: 140px;
    }

    /* Standup: current speaker & timer */
    .current-speaker {
      text-align: center;
      padding: 1.5rem;
      background: linear-gradient(135deg, var(--surface) 0%, var(--surface-hover) 100%);
      border-radius: 16px;
      margin-bottom: 1rem;
      border: 1px solid var(--border);
    }
    .current-speaker .label {
      font-size: 0.85rem;
      color: var(--text-muted);
      margin-bottom: 0.25rem;
    }
    .current-speaker .name {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--accent);
    }
    .timer-display {
      font-size: 2.5rem;
      font-weight: 700;
      font-variant-numeric: tabular-nums;
      margin: 0.75rem 0;
      color: var(--text);
    }
    .timer-display.warning {
      color: #f59e0b;
    }
    .timer-display.over {
      color: var(--accent);
      animation: pulse 1s ease infinite;
    }
    @keyframes pulse {
      50% { opacity: 0.8; }
    }
    .timer-controls {
      display: flex;
      gap: 0.75rem;
      justify-content: center;
      margin-top: 1rem;
    }

    /* Queue */
    .queue-section {
      margin-top: 1.25rem;
    }
    .queue-section h3 {
      font-size: 0.95rem;
      color: var(--text-muted);
      margin-bottom: 0.5rem;
    }
    .queue-list {
      list-style: none;
    }
    .queue-list li {
      padding: 0.5rem 0.75rem;
      border-radius: 8px;
      margin-bottom: 0.25rem;
      font-size: 0.9rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .queue-list li.done {
      color: var(--text-muted);
      text-decoration: line-through;
    }
    .queue-list li.current {
      background: var(--accent-soft);
      color: var(--accent);
      font-weight: 600;
    }
    .queue-list li .badge {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: var(--border);
      font-size: 0.7rem;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .queue-list li.current .badge {
      background: var(--accent);
      color: #fff;
    }
    .queue-list li.done .badge {
      background: var(--success);
      color: #fff;
    }

    /* Summary */
    .summary-card {
      background: var(--surface);
      border-radius: 16px;
      padding: 1.25rem;
      margin-bottom: 1rem;
      border: 1px solid var(--border);
    }
    .summary-card h3 {
      font-size: 1rem;
      margin-bottom: 0.75rem;
      color: var(--text-muted);
    }
    .summary-row {
      display: flex;
      justify-content: space-between;
      padding: 0.5rem 0;
      font-size: 0.95rem;
    }
    .summary-row.total {
      font-weight: 700;
      font-size: 1.1rem;
      color: var(--accent);
      border-top: 1px solid var(--border);
      margin-top: 0.5rem;
      padding-top: 0.75rem;
    }
    .summary-actions {
      margin-top: 1.5rem;
      display: flex;
      gap: 0.75rem;
      justify-content: center;
    }

    /* Utility */
    .mt-1 { margin-top: 1rem; }
    .text-center { text-align: center; }
  </style>
</head>
<body>
  <div class="container">
    <h1>ØªØµØ§Ø¯ÙÛŒâ€ŒØ³Ø§Ø² Ø§Ø³ØªÙ†Ø¯Ø¢Ù¾ <span class="team-name">ØªÛŒÙ… Ú©Ø§Ø±ÙˆØ§Ù†</span></h1>

    <!-- Setup screen -->
    <section id="screen-setup" class="screen active">
      <div class="member-form">
        <input type="text" id="member-input" placeholder="Ù†Ø§Ù… Ø¹Ø¶Ùˆ ØªÛŒÙ…" maxlength="50" enterkeyhint="done">
        <button type="button" class="btn btn-primary" id="btn-add">Ø§ÙØ²ÙˆØ¯Ù†</button>
      </div>
      <ul class="member-list" id="member-list"></ul>
      <div id="empty-members" class="empty-state">Ù‡Ù†ÙˆØ² Ø¹Ø¶ÙˆÛŒ Ø§Ø¶Ø§ÙÙ‡ Ù†Ø´Ø¯Ù‡. Ù†Ø§Ù… Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯ Ùˆ Ø§ÙØ²ÙˆØ¯Ù† Ø¨Ø²Ù†ÛŒØ¯.</div>
      <div class="timer-config">
        <label>Ù…Ø­Ø¯ÙˆØ¯ÛŒØª Ø²Ù…Ø§Ù† Ù‡Ø± Ù†ÙØ± (Ø¯Ù‚ÛŒÙ‚Ù‡)</label>
        <input type="range" id="timer-limit" min="1" max="5" value="2" step="1">
        <span class="value" id="timer-limit-value">Û² Ø¯Ù‚ÛŒÙ‚Ù‡</span>
      </div>
      <div class="shuffle-zone" id="shuffle-zone"></div>
      <div class="actions-row">
        <button type="button" class="btn btn-secondary" id="btn-shuffle">ğŸ”€ ØªØµØ§Ø¯ÙÛŒâ€ŒØ³Ø§Ø²ÛŒ</button>
        <button type="button" class="btn btn-primary" id="btn-start" disabled>Ø´Ø±ÙˆØ¹ Ø§Ø³ØªÙ†Ø¯Ø¢Ù¾</button>
      </div>
    </section>

    <!-- Standup screen -->
    <section id="screen-standup" class="screen">
      <div class="current-speaker">
        <div class="label">Ø¯Ø± Ø­Ø§Ù„ ØµØ­Ø¨Øª</div>
        <div class="name" id="current-name">â€”</div>
        <div class="timer-display" id="timer-display">Û²:Û°Û°</div>
        <div class="timer-controls">
          <button type="button" class="btn btn-secondary btn-icon" id="btn-pause" title="ØªÙˆÙ‚Ù/Ø§Ø¯Ø§Ù…Ù‡">â¸</button>
          <button type="button" class="btn btn-secondary" id="btn-skip">Ø±Ø¯ Ú©Ø±Ø¯Ù†</button>
        </div>
      </div>
      <div class="queue-section">
        <h3>ØµÙ Ù†ÙˆØ¨Øª</h3>
        <ul class="queue-list" id="queue-list"></ul>
      </div>
      <div class="actions-row mt-1">
        <button type="button" class="btn btn-ghost" id="btn-end-standup">Ù¾Ø§ÛŒØ§Ù† Ø§Ø³ØªÙ†Ø¯Ø¢Ù¾</button>
      </div>
    </section>

    <!-- Summary screen -->
    <section id="screen-summary" class="screen">
      <div class="summary-card">
        <h3>Ø®Ù„Ø§ØµÙ‡ Ø²Ù…Ø§Ù†â€ŒÙ‡Ø§</h3>
        <div id="summary-body"></div>
        <div class="summary-row total">
          <span>Ù…Ø¬Ù…ÙˆØ¹</span>
          <span id="summary-total">Û°:Û°Û°</span>
        </div>
      </div>
      <div class="summary-card">
        <h3>Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† Ø²Ù…Ø§Ù† Ù‡Ø± Ù†ÙØ±</h3>
        <div class="summary-row">
          <span>Ù…ÛŒØ§Ù†Ú¯ÛŒÙ†</span>
          <span id="summary-avg">Û°:Û°Û°</span>
        </div>
      </div>
      <div class="summary-actions">
        <button type="button" class="btn btn-primary" id="btn-new-standup">Ø§Ø³ØªÙ†Ø¯Ø¢Ù¾ Ø¬Ø¯ÛŒØ¯</button>
        <button type="button" class="btn btn-secondary" id="btn-back-setup">Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ ØªÙ†Ø¸ÛŒÙ…Ø§Øª</button>
      </div>
    </section>
  </div>

  <script>
    (function () {
      const PERSIAN_DIGITS = 'Û°Û±Û²Û³Û´ÛµÛ¶Û·Û¸Û¹';
      const STORAGE_KEY = 'standup_team_members';
      const STORAGE_LIMIT = 'standup_timer_limit';

      function toPersianNum(n) {
        return String(n).replace(/\d/g, d => PERSIAN_DIGITS[+d]);
      }

      function formatTime(seconds) {
        const m = Math.floor(seconds / 60);
        const s = seconds % 60;
        return toPersianNum(m) + ':' + toPersianNum(String(s).padStart(2, '0'));
      }

      function applyTheme(params) {
        if (!params) return;
        const doc = document.documentElement;
        if (params.bg_color) doc.style.setProperty('--bg', params.bg_color);
        if (params.text_color) doc.style.setProperty('--text', params.text_color);
        if (params.hint_color) doc.style.setProperty('--text-muted', params.hint_color);
        if (params.button_color) doc.style.setProperty('--accent', params.button_color);
        if (params.button_text_color) doc.querySelectorAll('.btn-primary').forEach(el => { el.style.color = params.button_text_color; });
      }

      let members = [];
      let queue = [];
      let timerLimitMinutes = 2;
      let timerSeconds = 0;
      let timerInterval = null;
      let isPaused = false;
      let spokeTimes = {}; // id or name -> seconds spoken

      const screenSetup = document.getElementById('screen-setup');
      const screenStandup = document.getElementById('screen-standup');
      const screenSummary = document.getElementById('screen-summary');
      const memberInput = document.getElementById('member-input');
      const memberList = document.getElementById('member-list');
      const emptyMembers = document.getElementById('empty-members');
      const timerLimitInput = document.getElementById('timer-limit');
      const timerLimitValue = document.getElementById('timer-limit-value');
      const shuffleZone = document.getElementById('shuffle-zone');
      const timerDisplay = document.getElementById('timer-display');
      const currentNameEl = document.getElementById('current-name');
      const queueList = document.getElementById('queue-list');
      const summaryBody = document.getElementById('summary-body');
      const summaryTotal = document.getElementById('summary-total');
      const summaryAvg = document.getElementById('summary-avg');

      function loadMembers() {
        try {
          const raw = localStorage.getItem(STORAGE_KEY);
          if (raw) members = JSON.parse(raw);
          else members = [];
        } catch (_) {
          members = [];
        }
      }

      function saveMembers() {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(members));
      }

      function loadTimerLimit() {
        const v = localStorage.getItem(STORAGE_LIMIT);
        if (v !== null) {
          const n = parseInt(v, 10);
          if (n >= 1 && n <= 5) timerLimitMinutes = n;
        }
      }

      function saveTimerLimit() {
        localStorage.setItem(STORAGE_LIMIT, String(timerLimitMinutes));
      }

      function renderMembers() {
        memberList.innerHTML = '';
        members.forEach((m, i) => {
          const li = document.createElement('li');
          li.className = 'member-item';
          li.innerHTML = '<span class="name">' + escapeHtml(m.name) + '</span><div class="actions"><button type="button" data-edit="' + i + '" aria-label="ÙˆÛŒØ±Ø§ÛŒØ´">âœï¸</button><button type="button" data-remove="' + i + '" aria-label="Ø­Ø°Ù">ğŸ—‘ï¸</button></div>';
          memberList.appendChild(li);
        });
        emptyMembers.style.display = members.length ? 'none' : 'block';
        document.getElementById('btn-start').disabled = members.length < 2;
      }

      function escapeHtml(s) {
        const div = document.createElement('div');
        div.textContent = s;
        return div.innerHTML;
      }

      function renderShuffleZone() {
        shuffleZone.innerHTML = '';
        queue.forEach(name => {
          const chip = document.createElement('span');
          chip.className = 'shuffle-chip';
          chip.textContent = name;
          shuffleZone.appendChild(chip);
        });
      }

      function shuffleAnimation() {
        const chips = shuffleZone.querySelectorAll('.shuffle-chip');
        chips.forEach((c, i) => {
          c.classList.add('shuffling');
          setTimeout(() => c.classList.remove('shuffling'), 120 + i * 180);
        });
      }

      function showScreen(id) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        const el = document.getElementById('screen-' + id);
        if (el) el.classList.add('active');
      }

      function addMember() {
        const name = memberInput.value.trim();
        if (!name) return;
        members.push({ id: Date.now().toString(), name });
        memberInput.value = '';
        saveMembers();
        renderMembers();
        renderShuffleZone();
      }

      function removeMember(index) {
        members.splice(index, 1);
        saveMembers();
        renderMembers();
        renderShuffleZone();
      }

      function editMember(index) {
        const m = members[index];
        const newName = prompt('Ù†Ø§Ù… Ø¬Ø¯ÛŒØ¯:', m.name);
        if (newName !== null && newName.trim()) {
          members[index].name = newName.trim();
          saveMembers();
          renderMembers();
          renderShuffleZone();
        }
      }

      const LAST_IN_ORDER = 'Ù…Ù„ÛŒÚ©Ø§ Ù…ÛŒØ§Ù‡ÛŒ';

      function ensureLastInQueue(arr) {
        const name = arr.find(n => n.trim() === LAST_IN_ORDER);
        if (!name) return arr;
        const rest = arr.filter(n => n.trim() !== LAST_IN_ORDER);
        return rest.concat([name]);
      }

      function shuffleQueue() {
        if (queue.length === 0) queue = members.map(m => m.name);
        for (let i = queue.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [queue[i], queue[j]] = [queue[j], queue[i]];
        }
        queue = ensureLastInQueue(queue);
        renderShuffleZone();
        shuffleAnimation();
      }

      function startStandup() {
        if (queue.length === 0) queue = ensureLastInQueue(members.map(m => m.name));
        spokeTimes = {};
        showScreen('standup');
        runCurrentSpeaker();
      }

      function runCurrentSpeaker() {
        if (queue.length === 0) {
          endStandup();
          return;
        }
        const name = queue[0];
        currentNameEl.textContent = name;
        timerSeconds = timerLimitMinutes * 60;
        currentSpeakerElapsedSeconds = 0;
        isPaused = false;
        document.getElementById('btn-pause').textContent = 'â¸';
        updateTimerDisplay();
        renderQueue();
        clearInterval(timerInterval);
        timerInterval = setInterval(() => {
          if (isPaused) return;
          timerSeconds--;
          currentSpeakerElapsedSeconds++;
          updateTimerDisplay();
          if (timerSeconds <= 0) {
            clearInterval(timerInterval);
            finishCurrent();
          }
        }, 1000);
      }

      function updateTimerDisplay() {
        const c = timerDisplay.classList;
        c.remove('warning', 'over');
        if (timerSeconds <= 30) c.add('over');
        else if (timerSeconds <= 60) c.add('warning');
        timerDisplay.textContent = formatTime(Math.max(0, timerSeconds));
      }

      function renderQueue() {
        queueList.innerHTML = '';
        queue.forEach((name, i) => {
          const li = document.createElement('li');
          li.className = i === 0 ? 'current' : '';
          if (spokeTimes[name] !== undefined) li.className = 'done';
          const badge = document.createElement('span');
          badge.className = 'badge';
          badge.textContent = spokeTimes[name] !== undefined ? 'âœ“' : (i + 1);
          li.appendChild(badge);
          li.appendChild(document.createTextNode(name));
          queueList.appendChild(li);
        });
      }

      let currentSpeakerElapsedSeconds = 0;

      function finishCurrent() {
        const name = queue[0];
        spokeTimes[name] = (spokeTimes[name] || 0) + currentSpeakerElapsedSeconds;
        queue.shift();
        runCurrentSpeaker();
      }

      function skipCurrent() {
        clearInterval(timerInterval);
        finishCurrent();
      }

      function togglePause() {
        isPaused = !isPaused;
        document.getElementById('btn-pause').textContent = isPaused ? 'â–¶' : 'â¸';
      }

      function endStandup() {
        clearInterval(timerInterval);
        const names = Object.keys(spokeTimes);
        const totalSeconds = names.reduce((sum, n) => sum + spokeTimes[n], 0);
        const avgSeconds = names.length ? Math.round(totalSeconds / names.length) : 0;
        summaryBody.innerHTML = names.map(n => '<div class="summary-row"><span>' + escapeHtml(n) + '</span><span>' + formatTime(spokeTimes[n]) + '</span></div>').join('');
        summaryTotal.textContent = formatTime(totalSeconds);
        summaryAvg.textContent = formatTime(avgSeconds);
        showScreen('summary');
      }

      memberInput.addEventListener('keydown', e => {
        if (e.key === 'Enter') addMember();
      });
      document.getElementById('btn-add').addEventListener('click', addMember);
      memberList.addEventListener('click', e => {
        const edit = e.target.closest('[data-edit]');
        const remove = e.target.closest('[data-remove]');
        if (edit) editMember(parseInt(edit.dataset.edit, 10));
        if (remove) removeMember(parseInt(remove.dataset.remove, 10));
      });
      timerLimitInput.addEventListener('input', () => {
        timerLimitMinutes = parseInt(timerLimitInput.value, 10);
        timerLimitValue.textContent = toPersianNum(timerLimitMinutes) + ' Ø¯Ù‚ÛŒÙ‚Ù‡';
        timerLimitValue.classList.remove('updated');
        void timerLimitValue.offsetWidth;
        timerLimitValue.classList.add('updated');
        setTimeout(() => timerLimitValue.classList.remove('updated'), 500);
        saveTimerLimit();
      });
      document.getElementById('btn-shuffle').addEventListener('click', shuffleQueue);
      document.getElementById('btn-start').addEventListener('click', startStandup);
      document.getElementById('btn-pause').addEventListener('click', togglePause);
